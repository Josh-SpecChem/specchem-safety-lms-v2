module.exports=[10547,e=>{"use strict";e.s(["lmsContentService",()=>V],10547);var t=e.i(8079),s=e.i(56412),r=e.i(63519),n=e.i(89726);e.i(57354);var o=e.i(34565),i=e.i(73253),c=e.i(77209);let a=async e=>(await n.db.select().from(o.courseSections).where((0,t.eq)(o.courseSections.id,e)).limit(1))[0]||null,d=async(e,s)=>(await n.db.select().from(o.courseSections).where((0,t.and)((0,t.eq)(o.courseSections.courseId,e),(0,t.eq)(o.courseSections.sectionKey,s))).limit(1))[0]||null,u=async(e,r={})=>{let{includeUnpublished:i=!1,sortBy:c="orderIndex",sortOrder:a="asc"}=r,d=(0,t.eq)(o.courseSections.courseId,e);i||(d=(0,t.and)(d,(0,t.eq)(o.courseSections.isPublished,!0)));let u="desc"===a?(0,s.desc)(o.courseSections[c]):(0,s.asc)(o.courseSections[c]);return await n.db.select().from(o.courseSections).where(d).orderBy(u)},l=async e=>{let r=await a(e);return r?{section:r,contentBlocks:await n.db.select().from(i.contentBlocks).where((0,t.eq)(i.contentBlocks.sectionId,e)).orderBy((0,s.asc)(i.contentBlocks.orderIndex)),quizQuestions:await n.db.select().from(c.quizQuestions).where((0,t.eq)(c.quizQuestions.sectionId,e)).orderBy((0,s.asc)(c.quizQuestions.orderIndex))}:null},m=async e=>(await n.db.insert(o.courseSections).values(e).returning())[0],S=async(e,s)=>(await n.db.update(o.courseSections).set({...s,updatedAt:new Date}).where((0,t.eq)(o.courseSections.id,e)).returning())[0]||null,p=async e=>(await n.db.delete(o.courseSections).where((0,t.eq)(o.courseSections.id,e)).returning()).length>0,g=async e=>{let s=await n.db.select({maxOrder:r.sql`max(${o.courseSections.orderIndex})`}).from(o.courseSections).where((0,t.eq)(o.courseSections.courseId,e));return(s[0]?.maxOrder||0)+1},I=async(e,s,i)=>{let c=(0,t.and)((0,t.eq)(o.courseSections.courseId,e),(0,t.eq)(o.courseSections.sectionKey,s));return i&&(c=(0,t.and)(c,r.sql`${o.courseSections.id} != ${i}`)),0===(await n.db.select({id:o.courseSections.id}).from(o.courseSections).where(c).limit(1)).length},w=async(e,t,s={})=>{let{includeUnpublished:r=!1}=s;return"safety_admin"===t?u(e,{includeUnpublished:!0}):u(e,{includeUnpublished:r})},A=async e=>(await n.db.insert(i.contentBlocks).values(e).returning())[0],O=async e=>{let s=await n.db.select({maxOrder:r.sql`max(${i.contentBlocks.orderIndex})`}).from(i.contentBlocks).where((0,t.eq)(i.contentBlocks.sectionId,e));return(s[0]?.maxOrder||0)+1},h=async(e,t)=>{let s=[];switch(e){case"hero":t.title||s.push("Hero blocks require a title");break;case"text":t.content||t.text||s.push("Text blocks require content or text");break;case"image":t.image?.url||s.push("Image blocks require an image URL");break;case"table":t.table?.headers&&t.table?.rows||s.push("Table blocks require headers and rows");break;case"list":t.list?.items&&Array.isArray(t.list.items)||s.push("List blocks require items array");break;case"callout":t.callout?.type&&t.callout?.content||s.push("Callout blocks require type and content");break;case"quote":t.quote?.text||s.push("Quote blocks require text");break;case"video":t.video?.url||s.push("Video blocks require a video URL");break;case"audio":t.audio?.url||s.push("Audio blocks require an audio URL")}return{isValid:0===s.length,errors:s}};var y=e.i(43048);let q=async e=>(await n.db.select().from(c.quizQuestions).where((0,t.eq)(c.quizQuestions.id,e)).limit(1))[0]||null,b=async(e,r={})=>{let{questionType:o,includeUnpublished:i=!1,sortBy:a="orderIndex",sortOrder:d="asc"}=r,u=(0,t.eq)(c.quizQuestions.sectionId,e);o&&(u=(0,t.and)(u,(0,t.eq)(c.quizQuestions.questionType,o))),i||(u=(0,t.and)(u,(0,t.eq)(c.quizQuestions.isPublished,!0)));let l="desc"===d?(0,s.desc)(c.quizQuestions[a]):(0,s.asc)(c.quizQuestions[a]);return await n.db.select().from(c.quizQuestions).where(u).orderBy(l)},v=async e=>(await n.db.insert(y.quizAttempts).values({...e,attemptedAt:new Date}).returning())[0];var D=e.i(29580);e.i(55923);let _=async e=>(await n.db.select().from(D.userProgress).where((0,t.eq)(D.userProgress.id,e)).limit(1))[0]||null,P=async(e,s)=>(await n.db.select().from(D.userProgress).where((0,t.and)((0,t.eq)(D.userProgress.userId,e),(0,t.eq)(D.userProgress.sectionId,s))).limit(1))[0]||null,T=async(e,r={})=>{let{courseId:o,sectionId:i,isCompleted:c,completionPercentageMin:a,completionPercentageMax:d,dateFrom:u,dateTo:l,sortBy:m="lastAccessedAt",sortOrder:S="desc"}=r,p=(0,t.eq)(D.userProgress.userId,e);o&&(p=(0,t.and)(p,(0,t.eq)(D.userProgress.courseId,o))),i&&(p=(0,t.and)(p,(0,t.eq)(D.userProgress.sectionId,i))),void 0!==c&&(p=(0,t.and)(p,(0,t.eq)(D.userProgress.isCompleted,c))),void 0!==a&&(p=(0,t.and)(p,(0,t.gte)(D.userProgress.completionPercentage,a))),void 0!==d&&(p=(0,t.and)(p,(0,t.lte)(D.userProgress.completionPercentage,d))),u&&(p=(0,t.and)(p,(0,t.gte)(D.userProgress.lastAccessedAt,u))),l&&(p=(0,t.and)(p,(0,t.lte)(D.userProgress.lastAccessedAt,l)));let g="desc"===S?(0,s.desc)(D.userProgress[m]):(0,s.asc)(D.userProgress[m]);return await n.db.select().from(D.userProgress).where(p).orderBy(g)},f=async e=>(await n.db.insert(D.userProgress).values(e).onConflictDoUpdate({target:[D.userProgress.userId,D.userProgress.sectionId],set:{isCompleted:e.isCompleted,completionPercentage:e.completionPercentage,timeSpentSeconds:e.timeSpentSeconds,lastAccessedAt:e.lastAccessedAt,completedAt:e.completedAt,updatedAt:new Date}}).returning())[0],E=async(e,s,r)=>(await n.db.update(D.userProgress).set({...r,updatedAt:new Date}).where((0,t.and)((0,t.eq)(D.userProgress.userId,e),(0,t.eq)(D.userProgress.sectionId,s))).returning())[0]||null,C=async(e,s)=>{let r=await n.db.select().from(o.courseSections).where((0,t.eq)(o.courseSections.courseId,s));if(0===r.length)return null;let i=await T(e,{courseId:s}),c=i.filter(e=>e.isCompleted).length,a=Math.round(c/r.length*100),d=i.reduce((e,t)=>e+t.timeSpentSeconds,0),u=i.length>0?i.reduce((e,t)=>t.lastAccessedAt>e?t.lastAccessedAt:e,i[0].lastAccessedAt):new Date,l=c===r.length&&r.length>0?i.reduce((e,t)=>t.completedAt&&t.completedAt>e?t.completedAt:e,i[0].completedAt||new Date(0)):void 0;return{courseId:s,userId:e,totalSections:r.length,completedSections:c,completionPercentage:a,timeSpentSeconds:d,lastAccessedAt:u,completedAt:l&&l.getTime()>0?l:void 0}},N=async(e,t,s)=>{let r=await _(e);return!!r&&(r.userId===t||"safety_admin"===s||"plant_manager"===s||"hr_admin"===s)},R=e=>({id:e.id,courseId:e.courseId,sectionKey:e.sectionKey,title:e.title,orderIndex:e.orderIndex,iconName:e.iconName,isPublished:e.isPublished,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}),x=e=>({id:e.id,sectionId:e.sectionId,blockType:e.blockType,orderIndex:e.orderIndex,content:e.content,metadata:e.metadata,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}),U=e=>({id:e.id,sectionId:e.sectionId,questionKey:e.questionKey,questionType:e.questionType,questionText:e.questionText,options:e.options,correctAnswer:e.correctAnswer,explanation:e.explanation,orderIndex:e.orderIndex,isPublished:e.isPublished,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}),k=(e,t,s)=>s?"safety_admin"===t||"plant_manager"===t?{hasAccess:!0,section:R(e),permissions:{canView:!0,canEdit:!0,canDelete:!0,canManageContent:!0}}:"safety_instructor"===t?{hasAccess:!0,section:R(e),permissions:{canView:!0,canEdit:!0,canDelete:!1,canManageContent:!0}}:"hr_admin"===t?{hasAccess:!0,section:R(e),permissions:{canView:!0,canEdit:!1,canDelete:!1,canManageContent:!0}}:"employee"===t?{hasAccess:e.isPublished,section:e.isPublished?R(e):void 0,permissions:{canView:e.isPublished,canEdit:!1,canDelete:!1,canManageContent:!1}}:{hasAccess:!1,reason:"User does not have access to this section"}:{hasAccess:!1,reason:"User does not have access to the course"},Q=e=>({id:e.id,sectionId:e.sectionId,questionKey:e.questionKey,questionType:e.questionType,questionText:e.questionText,options:e.options,correctAnswer:e.correctAnswer,explanation:e.explanation,orderIndex:e.orderIndex,isPublished:e.isPublished,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}),z=async(e,t,s="employee")=>{try{if("employee"===s)return{success:!1,error:{code:"USER_NOT_AUTHORIZED",message:"Insufficient permissions",timestamp:new Date().toISOString()},version:"1.0"};if(!await I(e,t.sectionKey))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Section key must be unique within the course",timestamp:new Date().toISOString()},version:"1.0"};t.orderIndex??await g(e);let r=((e,t)=>({courseId:t,sectionKey:e.sectionKey,title:e.title,orderIndex:e.orderIndex,iconName:e.iconName,isPublished:e.isPublished}))(t,e),n=await m(r);return{success:!0,data:R(n),version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},B=async(e,t,s="employee")=>{try{let r=await a(e);if(!r)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:"Section not found",timestamp:new Date().toISOString()},version:"1.0"};let n=k(r,s,!0);if(!n.hasAccess||!n.permissions?.canEdit)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:n.reason||"Access denied",timestamp:new Date().toISOString()},version:"1.0"};if(t.sectionKey&&t.sectionKey!==r.sectionKey&&!await I(r.courseId,t.sectionKey,e))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Section key must be unique within the course",timestamp:new Date().toISOString()},version:"1.0"};let o=((e,t)=>({...t,sectionKey:e.sectionKey??t.sectionKey,title:e.title??t.title,orderIndex:e.orderIndex??t.orderIndex,iconName:e.iconName??t.iconName,isPublished:e.isPublished??t.isPublished,updatedAt:new Date}))(t,r),i=await S(e,o);if(!i)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:"Failed to update section",timestamp:new Date().toISOString()},version:"1.0"};return{success:!0,data:R(i),version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},F=async(e,t="employee")=>{try{let s=await a(e);if(!s)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:"Section not found",timestamp:new Date().toISOString()},version:"1.0"};let r=k(s,t,!0);if(!r.hasAccess||!r.permissions?.canDelete)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:r.reason||"Access denied",timestamp:new Date().toISOString()},version:"1.0"};if(!await p(e))return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:"Failed to delete section",timestamp:new Date().toISOString()},version:"1.0"};return{success:!0,message:"Section deleted successfully",version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},K=async(e,t,s="employee")=>{try{if("employee"===s)return{success:!1,error:{code:"USER_NOT_AUTHORIZED",message:"Insufficient permissions",timestamp:new Date().toISOString()},version:"1.0"};let r=await a(e);if(!r)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:"Section not found",timestamp:new Date().toISOString()},version:"1.0"};let n=k(r,s,!0);if(!n.hasAccess||!n.permissions?.canEdit)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:n.reason||"Access denied",timestamp:new Date().toISOString()},version:"1.0"};let o=await h(t.blockType,t.content);if(!o.isValid)return{success:!1,error:{code:"VALIDATION_ERROR",message:o.errors.join(", "),timestamp:new Date().toISOString()},version:"1.0"};t.orderIndex??await O(e);let i=((e,t)=>({sectionId:t,blockType:e.blockType,orderIndex:e.orderIndex,content:e.content,metadata:e.metadata}))(t,e),c=await A(i);return{success:!0,data:(e=>({id:e.id,sectionId:e.sectionId,blockType:e.blockType,orderIndex:e.orderIndex,content:e.content,metadata:e.metadata,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}))(c),version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},M=async(e,t,s="employee")=>{try{let r;if("employee"===s)return{success:!1,error:{code:"USER_NOT_AUTHORIZED",message:"Insufficient permissions",timestamp:new Date().toISOString()},version:"1.0"};let n=await P(e,t.sectionId);if(n){let s=((e,t,s)=>{let r=new Date;return{...s,userId:t,courseId:e.courseId,sectionId:e.sectionId,isCompleted:e.isCompleted??s?.isCompleted??!1,completionPercentage:e.completionPercentage??s?.completionPercentage??0,timeSpentSeconds:e.timeSpentSeconds??s?.timeSpentSeconds??0,lastAccessedAt:r,completedAt:e.isCompleted?r:s?.completedAt,updatedAt:r}})(t,e,n);r=await E(e,t.sectionId,s)}else{let s=((e,t)=>{let s=new Date;return{userId:t,courseId:e.courseId,sectionId:e.sectionId,isCompleted:e.isCompleted??!1,completionPercentage:e.completionPercentage??0,timeSpentSeconds:e.timeSpentSeconds??0,lastAccessedAt:s,completedAt:e.isCompleted?s:void 0}})(t,e);r=await f(s)}if(!r)return{success:!1,error:{code:"PROGRESS_UPDATE_FAILED",message:"Failed to update progress",timestamp:new Date().toISOString()},version:"1.0"};return{success:!0,data:(e=>({id:e.id,userId:e.userId,courseId:e.courseId,sectionId:e.sectionId,isCompleted:e.isCompleted,completionPercentage:e.completionPercentage,timeSpentSeconds:e.timeSpentSeconds,lastAccessedAt:e.lastAccessedAt.toISOString(),completedAt:e.completedAt?.toISOString(),createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}))(r),version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},V={getCourseSections:async e=>({success:!0,data:[],pagination:{page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrev:!1}}),createCourseSection:async e=>z("",e),updateCourseSection:async(e,t)=>B(e,t),deleteCourseSection:async e=>F(e),getContentBlocks:async e=>({success:!0,data:[],pagination:{page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrev:!1}}),createContentBlock:async e=>K("",e),updateContentBlock:async(e,t)=>({success:!0,data:{}}),deleteContentBlock:async e=>({success:!0,message:"Content block deleted"}),getQuizQuestions:async e=>{try{let{pagination:t,sectionId:s}=e;if(!s)return{success:!1,error:"Section ID is required",data:[],pagination:{page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrev:!1}};let r=await b(s,{includeUnpublished:!1,sortBy:"orderIndex",sortOrder:"asc"}),n=r.length,o=Math.ceil(n/t.limit),i=(t.page-1)*t.limit,c=r.slice(i,i+t.limit);return{success:!0,data:c,pagination:{page:t.page,limit:t.limit,total:n,totalPages:o,hasNext:t.page<o,hasPrev:t.page>1}}}catch(e){return console.error("Error in getQuizQuestions service:",e),{success:!1,error:"Failed to fetch quiz questions",data:[],pagination:{page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrev:!1}}}},createQuizQuestion:async e=>({success:!0,data:{}}),updateQuizQuestion:async(e,t)=>({success:!0,data:{}}),deleteQuizQuestion:async e=>({success:!0,message:"Quiz question deleted"}),getUserProgress:async e=>({success:!0,data:[],pagination:{page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrev:!1}}),createUserProgress:async e=>M("",e),updateUserProgress:async(e,t)=>M("",t),deleteUserProgress:async e=>({success:!0,message:"User progress deleted"}),getCourseContent:async(e,t="en",s=!1,r="employee")=>{try{let t=await w(e,r,{includeUnpublished:s});return{success:!0,data:{course:{id:e,courseKey:e,title:"Function-Specific HazMat Training",description:"Handling, Packaging, and Shipping DOT-Regulated Materials",version:"1.0",isPublished:!0},sections:t.map(R)},version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},getSectionContent:async(e,t,s="en",r=!1,n="employee")=>{try{let s,r,o,i=await d(e,t);if(!i)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:"Section not found",timestamp:new Date().toISOString()},version:"1.0"};let c=k(i,n,!0);if(!c.hasAccess)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:c.reason||"Access denied",timestamp:new Date().toISOString()},version:"1.0"};let a=await l(i.id);if(!a)return{success:!1,error:{code:"COURSE_SECTION_NOT_FOUND",message:"Section content not found",timestamp:new Date().toISOString()},version:"1.0"};return{success:!0,data:(s=a.section,r=a.contentBlocks,o=a.quizQuestions,{section:R(s),contentBlocks:r.map(x),quizQuestions:o.map(U)}),version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},submitQuizAnswer:async(e,t,s,r="employee")=>{try{let n=await q(e);if(!n)return{success:!1,error:{code:"QUIZ_QUESTION_NOT_FOUND",message:"Quiz question not found",timestamp:new Date().toISOString()},version:"1.0"};let o=((e,t,s)=>s?"safety_admin"===t||"plant_manager"===t?{hasAccess:!0,question:Q(e),permissions:{canView:!0,canEdit:!0,canDelete:!0,canSubmitAnswer:!0}}:"safety_instructor"===t?{hasAccess:!0,question:Q(e),permissions:{canView:!0,canEdit:!0,canDelete:!1,canSubmitAnswer:!0}}:"hr_admin"===t?{hasAccess:!0,question:Q(e),permissions:{canView:!0,canEdit:!1,canDelete:!1,canSubmitAnswer:!0}}:"employee"===t?{hasAccess:e.isPublished,question:e.isPublished?Q(e):void 0,permissions:{canView:e.isPublished,canEdit:!1,canDelete:!1,canSubmitAnswer:e.isPublished}}:{hasAccess:!1,reason:"User does not have access to this quiz question"}:{hasAccess:!1,reason:"User does not have access to the section"})(n,r,!0);if(!o.hasAccess||!o.permissions?.canSubmitAnswer)return{success:!1,error:{code:"QUIZ_QUESTION_NOT_FOUND",message:o.reason||"Access denied",timestamp:new Date().toISOString()},version:"1.0"};let i=((e,t)=>{let s=[];switch(e.questionType){case"true-false":"boolean"!=typeof t&&s.push("True/false questions require a boolean answer");break;case"multiple-choice":"string"!=typeof t?s.push("Multiple choice questions require a string answer"):!e.options||t in e.options||s.push("Answer must be one of the provided options")}return s.length>0?{isValid:!1,isCorrect:!1,errors:s}:{isValid:!0,isCorrect:t===e.correctAnswer,errors:[],explanation:e.explanation}})(n,t.userAnswer);if(!i.isValid)return{success:!1,error:{code:"INVALID_QUIZ_ANSWER",message:i.errors.join(", "),timestamp:new Date().toISOString()},version:"1.0"};let c=((e,t,s)=>({userId:t,quizQuestionId:e.quizQuestionId,userAnswer:e.userAnswer,isCorrect:s,timeSpentSeconds:e.timeSpentSeconds,attemptedAt:new Date}))(t,s,i.isCorrect),a=await v(c);return{success:!0,data:(e=>({id:e.id,userId:e.userId,quizQuestionId:e.quizQuestionId,userAnswer:e.userAnswer,isCorrect:e.isCorrect,attemptedAt:e.attemptedAt.toISOString(),timeSpentSeconds:e.timeSpentSeconds}))(a),version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}},getCourseCompletionStatus:async(e,t,s="employee")=>{try{if(!await N("",e,s))return{success:!1,error:{code:"USER_NOT_AUTHORIZED",message:"Access denied",timestamp:new Date().toISOString()},version:"1.0"};let r=await C(e,t);if(!r)return{success:!1,error:{code:"COURSE_NOT_FOUND",message:"Course not found",timestamp:new Date().toISOString()},version:"1.0"};return{success:!0,data:(e=>({courseId:e.courseId,userId:e.userId,totalSections:e.totalSections,completedSections:e.completedSections,completionPercentage:e.completionPercentage,timeSpentSeconds:e.timeSpentSeconds,lastAccessedAt:e.lastAccessedAt.toISOString(),completedAt:e.completedAt?.toISOString()}))(r),version:"1.0"}}catch(e){return{success:!1,error:{code:"SYSTEM_ERROR",message:"Internal server error",timestamp:new Date().toISOString()},version:"1.0"}}}}}];

//# sourceMappingURL=apps_safety-lms_src_lib_services_lms-content-service_ts_1bcd5f19._.js.map